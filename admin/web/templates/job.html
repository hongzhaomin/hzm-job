<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../static/layui-mini/lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../static/layui-mini/css/public.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <!-- 搜索栏 -->
        <fieldset class="table-search-fieldset">
            <legend>搜索信息</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" autocomplete="off" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">执行器</label>
                            <div class="layui-input-inline">
                                <select name="executorId" lay-search="">
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">状态</label>
                            <div class="layui-input-inline">
                                <select name="status">
                                    <option value="">全部</option>
                                    <option value="1">Running</option>
                                    <option value="0">Stop</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">任务名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="name" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">任务描述</label>
                            <div class="layui-input-inline">
                                <input type="text" name="description" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">负责人</label>
                            <div class="layui-input-inline">
                                <input type="text" name="head" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <button id="searchBtn" type="submit" class="layui-btn layui-btn-normal" lay-submit
                                    lay-filter="data-search-btn">
                                <i class="layui-icon"></i>
                                搜 索
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <!-- 工具栏 -->
        <script type="text/html" id="toolbar-executor">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add"> 添加</button>
                <button class="layui-btn layui-btn-sm layui-btn-danger data-delete-btn" lay-event="delete"> 删除
                </button>
            </div>
        </script>

        <!-- 任务列表 -->
        <table class="layui-hide" id="jobTableId" lay-filter="currentTableFilter"></table>

        <!-- 操作列按钮 -->
        <script type="text/html" id="operateTableBar">
            <a class="layui-btn layui-btn-xs layui-btn-normal data-count-edit" lay-event="edit">编辑</a>
            {{# if (d.status === 0) { }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="jobSwitch">启动</a>
            {{# } else if (d.status === 1) { }}
            <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="jobSwitch">停止</a>
            {{# } }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="more">更多<i
                    class="layui-icon layui-icon-triangle-d"></i></a>
        </script>

    </div>
</div>
<script src="../static/layui-mini/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../static/layui-mini/js/lay-config.js?v=2.0.0" charset="utf-8"></script>
<script>
    layui.use(['form', 'table', 'loginCheck', 'layer', 'dropdown', 'laytpl', 'miniTab'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            dropdown = layui.dropdown,
            laytpl = layui.laytpl,
            miniTab = layui.miniTab,
            layer = layui.layer;

        // 初始化下拉框
        $.getJSON('/admin/executor/select-box', function (res) {
            if (res.success) {
                let optionsHtml = '';
                if (res.data) {
                    for (let item of res.data) {
                        optionsHtml += `<option value="${item.value}">${item.name}</option>`;
                    }
                }
                let executorIdSelect = $('select[name="executorId"]').append(optionsHtml);
                // 重新渲染下拉框
                form.render('select');

                // 表格渲染
                let executorId = executorIdSelect.val();
                let query = {}
                if (executorId) {
                    query.executorId = parseInt(executorId);
                }
                tableRender(query)
            } else {
                tableRender()
            }
        });

        function tableRender(where) {
            table.render({
                elem: '#jobTableId',
                url: '/admin/job/page',
                where: where,
                toolbar: '#toolbar-executor',
                defaultToolbar: ['filter'],
                cols: [[
                    {type: "checkbox", width: 50},
                    {field: 'id', title: 'ID', width: 80, sort: true},
                    {field: 'name', title: '任务名称'},
                    {field: 'description', title: '任务描述'},
                    {
                        field: 'scheduleType', title: '调度类型', templet: function (d) {
                            if (d.scheduleType === 1) {
                                return 'cron: ' + d.scheduleValue;
                            } else if (d.scheduleType === 2) {
                                return 'simple: ' + d.scheduleValue;
                            }
                            return '';
                        }
                    },
                    {field: 'head', title: '负责人'},
                    {
                        field: 'status', title: '任务状态', templet: function (d) {
                            if (d.status === 0) {
                                return '<span class="layui-badge">Stop</span>';
                            } else if (d.status === 1) {
                                return '<span class="layui-badge layui-bg-green">Running</span>';
                            }
                            return '';
                        }
                    },
                    {title: '操作', minWidth: 150, toolbar: '#operateTableBar', align: "center", fixed: "right"}
                ]],
                limits: [10, 15, 20, 25, 50, 100],
                // limit: 1,
                page: true,
                request: {
                    pageName: 'currentPage', // 页码的参数名称，默认：page
                    limitName: 'pageSize' // 每页数据量的参数名，默认：limit
                },
                // response: {
                //     // statusName: 'status', // 规定数据状态的字段名称，默认：code
                //     // statusCode: 200, // 规定成功的状态码，默认：0
                //     // msgName: 'hint', // 规定状态信息的字段名称，默认：msg
                //     // countName: 'total', // 规定数据总数的字段名称，默认：count
                //     // dataName: 'rows' // 规定数据列表的字段名称，默认：data
                // },
                parseData: function (res) { //res 即为原始返回的数据
                    return {
                        "code": res.code === 200 ? 0 : res.code, // 解析接口状态
                        "msg": res.msg, // 解析提示文本
                        "count": res.count, // 解析数据长度
                        "data": res.data // 解析数据列表
                    };
                },

                // line （行边框风格）
                // row （列边框风格）
                // nob （无边框风格）
                // skin: 'line'
            });
        }

        // 监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            const {executorId, status, name, description, head} = data.field
            let query = {name, description, head}
            if (executorId) {
                query.executorId = parseInt(executorId);
            }
            if (status) {
                query.status = parseInt(status);
            }

            // 执行搜索重载
            table.reload('jobTableId', {
                page: {
                    curr: 1
                },
                where: query
            }, 'data');

            return false;
        });

        /**
         * toolbar监听事件
         */
        table.on('toolbar(currentTableFilter)', function (obj) {
            if (obj.event === 'add') {  // 监听添加操作
                var index = layer.open({
                    title: '添加任务',
                    type: 2,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    skin: 'layui-layer-molv',
                    area: ['60%', '98%'],
                    btn: ['保存', '取消'],
                    yes: function (index, layero) {
                        // 向子页面传递参数
                        // 获取子页面window对象
                        const childWindow = layero.find('iframe')[0].contentWindow;
                        // 调用子页面表单提交方法
                        if (childWindow.addJobSubmit) {
                            childWindow.addJobSubmit(index);
                        }
                    },
                    btn2: function (index, layero) {
                        layer.close(index);
                    },
                    content: 'job-add-layer',
                    end: doSearch
                });
            } else if (obj.event === 'delete') {  // 监听删除操作
                var checkStatus = table.checkStatus('jobTableId')
                    , data = checkStatus.data;
                let ids = data.map(v => v.id);
                if (ids === undefined || ids.length <= 0) {
                    layer.msg('未勾选删除执行器', {icon: 5, time: 1000});
                    return
                }
                deleteJobs(ids);
            }
        });

        // 监听表格复选框选择
        // table.on('checkbox(currentTableFilter)', function (obj) {
        // });

        // 操作栏按钮事件监听
        table.on('tool(currentTableFilter)', function (obj) {
            let data = obj.data;
            if (obj.event === 'edit') {
                layer.open({
                    title: '编辑任务: ' + data.name,
                    type: 2,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    skin: 'layui-layer-molv',
                    area: ['60%', '98%'],
                    btn: ['保存', '取消'],
                    content: 'job-edit-layer',
                    yes: function (index, layero) {
                        // 向子页面传递参数
                        // 获取子页面window对象
                        const childWindow = layero.find('iframe')[0].contentWindow;
                        // 调用子页面表单提交方法
                        if (childWindow.editJobSubmit) {
                            childWindow.editJobSubmit(index);
                        }
                    },
                    btn2: function (index, layero) {
                        layer.close(index);
                    },
                    success: function (layero, index) {
                        // 回显数据
                        // 向子页面传递参数
                        // 获取子页面window对象
                        const childWindow = layero.find('iframe')[0].contentWindow;
                        // 调用子页面初始化方法
                        if (childWindow.initJobEditLayer) {
                            childWindow.initJobEditLayer(data);
                        }
                    },
                    end: doSearch
                });
                return false;
            } else if (obj.event === 'jobSwitch') {
                if ($(this).hasClass("layui-btn-disabled")) {
                    return false; // 阻止禁用状态下的点击
                }
                // 任务开关
                let btnName = data.status === 1 ? '停止' : '启动';
                layer.confirm('确定' + btnName + '任务', {icon: 3, title: '提示'}, function (index) {
                    $.post('/admin/job/switch', {jobId: data.id}, function (res) {
                        if (res.success) {
                            layer.msg('任务' + btnName + '成功', {icon: 6, time: 1000});
                            doSearch();
                        } else {
                            layer.msg(res.msg, {icon: 5, time: 1000});
                        }
                    }, 'json');
                    layer.close(index);
                });
            } else if (obj.event === 'more') {
                // 更多下拉菜单
                dropdown.render({
                    elem: this,
                    show: true, //外部事件触发即显示
                    data: [
                        {
                            title: '执行一次',
                            id: 'run'
                        },
                        {
                            title: '查询日志',
                            id: 'queryLog'
                        },
                        {
                            title: '删除',
                            id: 'del'
                        }
                    ],
                    click: function (dropdownData, othis) {
                        // 根据 id 做出不同操作
                        if (dropdownData.id === 'run') {
                            var tplRenderData = {parameters: data.parameters}
                            var getTpl = jobRunOnceLayerTpl.innerHTML;
                            laytpl(getTpl).render(tplRenderData, function (html) {
                                layer.open({
                                    title: '执行一次: ' + data.name,
                                    type: 1,
                                    shade: 0.2,
                                    maxmin: true,
                                    shadeClose: true,
                                    skin: 'layui-layer-molv',
                                    area: ['40%', '65%'],
                                    content: html,
                                    btn: ['确认执行', '取消'],
                                    yes: function (index, layero) {
                                        let query = {id: data.id}
                                        // 两种方式获取都可以
                                        query.parameters = $(layero).find('textarea[name="parameters"]').val();
                                        let executorNodeId = $('select[name="executorNodeId"]').val();
                                        if (executorNodeId) {
                                            query.executorNodeId = parseInt(executorNodeId);
                                        }
                                        $.post('/admin/job/run-once', query, function (res) {
                                            if (res.success) {
                                                let idx = layer.msg('任务执行一次成功', {
                                                    icon: 6,
                                                    time: 500
                                                }, function () {
                                                    // 关闭消息弹框
                                                    layer.close(idx);
                                                    // 关闭执行一次弹框
                                                    layer.close(index);
                                                });
                                            } else {
                                                layer.msg(res.msg, {icon: 5, time: 1000});
                                            }
                                        }, 'json');
                                    },
                                    btn2: function (index, layero) {
                                        layer.close(index);
                                    },
                                    success: function (layero, index) {
                                        // 需要重新渲染下拉框，否则样式有问题
                                        form.render('select');
                                        form.render('textarea');
                                        $.getJSON('/admin/executor/nodes/by-executorid', {executorId: data.executorId}, function (res) {
                                            if (res.success) {
                                                let optionsHtml = '';
                                                if (res.data) {
                                                    for (let item of res.data) {
                                                        if (item.status === 1) {
                                                            optionsHtml += `<option value="${item.id}">${item.address}</option>`;
                                                        }
                                                    }
                                                }
                                                $('select[name="executorNodeId"]').append(optionsHtml);
                                                // 重新渲染下拉框
                                                form.render('select');
                                            }
                                        });
                                    },
                                    end: doSearch
                                });
                            });
                        } else if (dropdownData.id === 'queryLog') {
                            $.getJSON('/admin/menu/get-log-menu', function (res) {
                                if (res.success) {
                                    let opt = {
                                        tabId: res.data.href,
                                        href: res.data.href + '?jobId=' + obj.data.id + '&executorId=' + data.executorId,
                                        title: res.data.title,
                                        isIframe: true
                                    }
                                    // 检查tab是否存在，如果存在则直接跳转，否则创建新tab
                                    let checkTab = miniTab.check(opt.tabId, true);
                                    if (!checkTab) {
                                        miniTab.create(opt);
                                        parent.layui.element.tabChange('layuiminiTab', opt.tabId);
                                    } else {
                                        parent.layui.element.tabChange('layuiminiTab', opt.tabId);
                                        const iframeWindow = parent.layui.$(".layui-tab-item.layui-show").find("iframe")[0].contentWindow;
                                        // 调用页面初始化方法
                                        if (iframeWindow.initLog) {
                                            iframeWindow.initLog({
                                                jobId: data.id,
                                                executorId: data.executorId
                                            });
                                        }
                                        // 刷新
                                        // iframeWindow.location.reload();
                                    }
                                }
                            });
                        } else if (dropdownData.id === 'del') {
                            deleteJobs(Array.of(obj.data.id));
                        }
                    },
                    // align: 'center', //右对齐弹出（v2.6.8 新增）
                    // style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);' //设置额外样式
                });
                return false;
            }
        });

        // 触发排序事件
        table.on('sort(currentTableFilter)', function (obj) { //注：sort 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值 "
            // console.log(obj.field); //当前排序的字段名
            // console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
            // console.log(this); //当前排序的 th 对象

            //尽管我们的 table 自带排序功能，但并没有请求服务端。
            //有些时候，你可能需要根据当前排序的字段，重新向服务端发送请求，从而实现服务端排序，如：
            table.reload('jobTableId', {
                initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。
                , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                    field: obj.field //排序字段
                    , order: obj.type //排序方式
                }
            });

            // layer.msg('服务端排序。order by ' + obj.field + ' ' + obj.type);
        });

        function deleteJobs(ids) {
            layer.confirm('确定删除', {icon: 3, title: '提示'}, function (index) {
                $.ajax({
                    url: '/admin/job/del',
                    type: "post",
                    data: JSON.stringify(ids),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (res) {
                        if (res.success) {
                            layer.msg('任务删除成功', {icon: 6, time: 1000});
                            doSearch();
                        } else {
                            layer.msg(res.msg, {icon: 5, time: 1000});
                        }
                    }
                });
                layer.close(index);
            });
        }

        function doSearch() {
            $('#searchBtn').click();
        }
    });
</script>

</body>

<script id="jobRunOnceLayerTpl" type="text/html">
    <div style="margin-top: 10px; margin-right: 20px">
        <div class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label">任务参数</label>
                <div class="layui-input-block">
                        <textarea name="parameters" placeholder="请输入本次执行的任务参数" value=""
                                  class="layui-textarea">{{d.parameters}}</textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">节点地址</label>
                <div class="layui-input-block">
                    <select name="executorNodeId">
                        <option value="">请选择本次执行的机器节点地址，为空则根据策略选择</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</script>

</html>